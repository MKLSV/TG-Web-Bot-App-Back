const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
const cors = require('cors');

const token = '7807455574:AAHd0hfHtP9smCnuoYK2zAGRRCEGEviVByw';
const webAppUrl = 'https://tg-web-bot-app-react.vercel.app';

const bot = new TelegramBot(token, { polling: true }); // ÐœÐ¾Ð¶Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ polling Ð½Ð° Render

const app = express();
app.use(express.json());
app.use(cors());

// === Ð¢ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼ Ð»Ð¾Ð³Ð¸ÐºÐ° ===
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;

    if (text === '/start') {
        await bot.sendMessage(chatId, 'ÐÐ¸Ð¶Ðµ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ ÐºÐ½Ð¾Ð¿ÐºÐ°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸ Ñ„Ð¾Ñ€Ð¼Ñƒ', {
            reply_markup: {
                keyboard: [
                    [{ text: 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ', web_app: { url: webAppUrl + '/form' } }]
                ]
            }
        });

        await bot.sendMessage(chatId, 'Ð—Ð°Ñ…Ð¾Ð´Ð¸ Ð² Ð½Ð°Ñˆ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ Ð½Ð¸Ð¶Ðµ', {
            reply_markup: {
                inline_keyboard: [
                    [{ text: 'Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·', web_app: { url: webAppUrl } }]
                ]
            }
        });
    }

    if (msg?.web_app_data?.data) {
        try {
            const data = JSON.parse(msg.web_app_data.data);
            console.log(data);

            await bot.sendMessage(chatId, 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‚Ð½ÑƒÑŽ ÑÐ²ÑÐ·ÑŒ!');
            await bot.sendMessage(chatId, 'Ð’Ð°ÑˆÐ° ÑÑ‚Ñ€Ð°Ð½Ð°: ' + data?.country);
            await bot.sendMessage(chatId, 'Ð’Ð°ÑˆÐ° ÑƒÐ»Ð¸Ñ†Ð°: ' + data?.street);

            setTimeout(async () => {
                await bot.sendMessage(chatId, 'Ð’ÑÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð² ÑÑ‚Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ');
            }, 3000);
        } catch (e) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· web_app_data:', e);
        }
    }
});

// === ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° POST-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¾Ñ‚ WebApp ===
app.post('/web-data', async (req, res) => {
    const { queryId, products = [], totalPrice } = req.body;

    try {
        await bot.answerWebAppQuery(queryId, {
            type: 'article',
            id: queryId,
            title: 'Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ°',
            input_message_content: {
                message_text: `ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÑŽ Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¾Ð¹! Ð’Ñ‹ Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð½Ð° ÑÑƒÐ¼Ð¼Ñƒ ${totalPrice}â‚½: ${products.map(p => p.title).join(', ')}`
            }
        });
        return res.status(200).json({});
    } catch (e) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ñ‡ÐµÑ€ÐµÐ· WebAppQuery:', e);
        return res.status(500).json({});
    }
});

// === ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð° Ð´Ð»Ñ Render ===
const PORT = process.env.PORT || 8000;
app.listen(PORT, '0.0.0.0', () => {
    console.log('ðŸš€ Server started on PORT ' + PORT);
});
